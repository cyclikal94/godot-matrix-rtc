name: Build and Release Addon

on:
  push:
    branches:
      - main
    paths:
      - "addons/**"
      - ".github/workflows/release.yml"
  workflow_dispatch:
    inputs:
      element_call_ref:
        description: "Optional Element Call branch, tag, or commit to build from"
        required: false
        default: ""

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build MatrixRTC SDK dist from Element Call
        env:
          ELEMENT_CALL_REF: ${{ github.event.inputs.element_call_ref }}
        run: |
          set -euo pipefail
          corepack enable
          # Isolate git from any malformed inherited config/env on the runner.
          unset GIT_CONFIG_PARAMETERS || true
          unset GIT_CONFIG_COUNT || true
          while IFS='=' read -r key _; do
            case "$key" in
              GIT_CONFIG_KEY_*|GIT_CONFIG_VALUE_*) unset "$key" ;;
            esac
          done < <(env)
          export HOME=/tmp/element-call-home
          mkdir -p "${HOME}"
          git config --global core.autocrlf false

          git clone --depth 1 https://github.com/element-hq/element-call.git /tmp/element-call
          cd /tmp/element-call
          REF="${ELEMENT_CALL_REF:-}"
          if [ -n "${REF}" ]; then
            if git ls-remote --exit-code --heads origin "${REF}" >/dev/null 2>&1; then
              git fetch --depth 1 origin "${REF}"
              git checkout FETCH_HEAD
            elif git ls-remote --exit-code --tags origin "${REF}" >/dev/null 2>&1; then
              git fetch --depth 1 origin "refs/tags/${REF}:refs/tags/${REF}"
              git checkout "${REF}"
            else
              echo "Requested Element Call ref '${REF}' was not found as a branch or tag." >&2
              exit 1
            fi
          fi
          yarn install --immutable || yarn install --frozen-lockfile || yarn install
          yarn build:sdk
          test -d dist

      - name: Copy dist into addon
        run: |
          set -euo pipefail
          rm -rf addons/godot-matrix-rtc/dist
          cp -R /tmp/element-call/dist addons/godot-matrix-rtc/dist

      - name: Extract version from plugin.cfg
        id: extract_version
        run: |
          set -euo pipefail
          VERSION=$(grep '^version=' addons/godot-matrix-rtc/plugin.cfg | cut -d'=' -f2 | tr -d '"' | tr -d '[:space:]')
          if [ -z "${VERSION}" ]; then
            echo "Failed to read version from addons/godot-matrix-rtc/plugin.cfg" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Create zip artifact
        id: package
        run: |
          set -euo pipefail
          VERSION="${{ steps.extract_version.outputs.version }}"
          ARCHIVE="godot-matrix-rtc-${VERSION}.zip"
          zip -r "${ARCHIVE}" addons
          echo "archive=${ARCHIVE}" >> "${GITHUB_OUTPUT}"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.extract_version.outputs.version }}
          name: Godot Matrix RTC v${{ steps.extract_version.outputs.version }}
          draft: false
          prerelease: false
          files: ${{ steps.package.outputs.archive }}
